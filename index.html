<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éš¨èº«æ—¥èª Pocket Nihongo Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif;
            background-color: #f9fafb;
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Nav active state */
        .nav-item.active { color: #ef4444; }
        .nav-item.active i { transform: translateY(-2px); }

        /* Level Badges */
        .badge-n5 { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .badge-n4 { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .badge-n3 { background-color: #fae8ff; color: #86198f; border: 1px solid #f5d0fe; }

        /* Audio Wave Animation */
        .playing-indicator span {
            display: inline-block;
            width: 3px;
            height: 10px;
            background-color: #ef4444;
            margin: 0 1px;
            animation: audio-wave 0.8s infinite ease-in-out;
        }
        .playing-indicator span:nth-child(2) { animation-delay: 0.1s; }
        .playing-indicator span:nth-child(3) { animation-delay: 0.2s; }
        @keyframes audio-wave {
            0%, 100% { height: 5px; }
            50% { height: 15px; }
        }

        /* Loading Toast */
        #tts-toast {
            animation: slide-up 0.3s ease-out;
        }
        @keyframes slide-up {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-gray-50">

    <!-- TTS Loading Indicator -->
    <div id="tts-toast" class="hidden fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-gray-900/90 text-white px-6 py-3 rounded-full shadow-lg z-50 items-center gap-3 backdrop-blur-sm">
        <i class="fa-solid fa-circle-notch fa-spin text-indigo-400"></i>
        <span class="text-sm font-bold tracking-wide">æ­£åœ¨è®€å–èªéŸ³...</span>
    </div>

    <!-- Top Header -->
    <header class="bg-white shadow-sm z-10 px-4 py-3 flex justify-between items-center sticky top-0">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-torii-gate text-red-500 text-xl"></i>
            <h1 class="text-lg font-bold tracking-wide">Pocket Nihongo <span class="text-xs bg-red-100 text-red-600 px-1 rounded ml-1">Pro</span></h1>
        </div>
        <div id="header-title" class="text-sm text-gray-500 font-medium">é¦–é </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-content" class="flex-1 overflow-y-auto no-scrollbar relative p-4 pb-24">
        
        <!-- VIEW: HOME -->
        <div id="view-home" class="space-y-6">
            <!-- Welcome Card -->
            <div class="bg-gradient-to-r from-red-500 to-pink-500 rounded-2xl p-6 text-white shadow-lg shadow-red-200 relative overflow-hidden">
                <div class="relative z-10">
                    <p class="text-sm opacity-90 mb-1">ä»Šæ—¥ä¸€å¥</p>
                    <h2 id="daily-sentence-jp" class="text-2xl font-bold font-jp mb-2">åƒé‡Œã®é“ã‚‚ä¸€æ­©ã‹ã‚‰</h2>
                    <p id="daily-sentence-reading" class="text-sm opacity-90 mb-1">Senri no michi mo ippo kara</p>
                    <p id="daily-sentence-cn" class="text-sm font-medium border-t border-white/30 pt-2 mt-2">åƒé‡Œä¹‹è¡Œï¼Œå§‹æ–¼è¶³ä¸‹</p>
                    <button onclick="speakText(document.getElementById('daily-sentence-jp').innerText)" class="mt-3 bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full text-xs flex items-center gap-2 w-fit transition">
                        <i class="fa-solid fa-volume-high"></i> <span id="daily-play-text">æ’­æ”¾ç™¼éŸ³</span>
                    </button>
                </div>
                <i class="fa-solid fa-sakura absolute -bottom-4 -right-4 text-9xl text-white opacity-10"></i>
            </div>

            <!-- Main Actions -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 active:bg-gray-50 transition cursor-pointer" onclick="switchTab('roadmap')">
                    <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center text-xl">
                        <i class="fa-solid fa-map-location-dot"></i>
                    </div>
                    <div class="text-center">
                        <span class="font-bold block text-gray-800">å­¸ç¿’è·¯å¾‘</span>
                        <span class="text-xs text-gray-400">å®Œæ•´èª²ç¨‹èˆ‡æ–‡æ³•</span>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 active:bg-gray-50 transition cursor-pointer" onclick="switchTab('ai')">
                    <div class="w-12 h-12 rounded-full bg-indigo-100 text-indigo-500 flex items-center justify-center text-xl">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </div>
                    <div class="text-center">
                        <span class="font-bold block text-gray-800">AI å·¥å…·ç®±</span>
                        <span class="text-xs text-gray-400">ç¿»è­¯ & æƒ…å¢ƒæ¨¡æ“¬</span>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center">
                        <i class="fa-solid fa-fire"></i>
                    </div>
                    <div>
                        <div class="font-bold text-gray-800">å­¸ç¿’ç†±åº¦</div>
                        <div class="text-xs text-gray-500">é€£çºŒ <span id="streak-count" class="font-bold text-orange-500">1</span> å¤©</div>
                    </div>
                </div>
                <button onclick="switchTab('quiz')" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-xs font-bold">å»æ¸¬é©—</button>
            </div>
        </div>

        <!-- VIEW: ROADMAP -->
        <div id="view-roadmap" class="hidden space-y-6">
            <div class="pl-4 border-l-2 border-gray-200 space-y-8 relative">
                
                <!-- Level N5 -->
                <div class="relative">
                    <span class="absolute -left-[25px] top-0 w-5 h-5 bg-blue-500 rounded-full border-4 border-white shadow-sm"></span>
                    <h3 class="font-bold text-xl text-blue-800 mb-2">Level N5 <span class="text-xs font-normal text-gray-500 ml-2">å…¥é–€åŸºç¤</span></h3>
                    <div class="space-y-2">
                        <div onclick="openKanaView()" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3 active:scale-95 transition cursor-pointer">
                            <div class="w-8 h-8 rounded bg-blue-50 text-blue-500 flex items-center justify-center font-bold">ã‚</div>
                            <div class="flex-1">
                                <div class="font-bold text-sm">äº”åéŸ³åœ–è¡¨</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                        <div onclick="filterVocabByLevel('N5')" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3 active:scale-95 transition cursor-pointer">
                            <div class="w-8 h-8 rounded bg-pink-50 text-pink-500 flex items-center justify-center"><i class="fa-solid fa-list-ul"></i></div>
                            <div class="flex-1">
                                <div class="font-bold text-sm">N5 å–®å­—åº« (åè©/å‹•è©/å½¢å®¹è©)</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                        <div onclick="openGrammarView('N5')" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3 active:scale-95 transition cursor-pointer">
                            <div class="w-8 h-8 rounded bg-green-50 text-green-500 flex items-center justify-center"><i class="fa-solid fa-shapes"></i></div>
                            <div class="flex-1">
                                <div class="font-bold text-sm">N5 å¿…ä¿®æ–‡æ³• (åŸºç¤åŠ©è©/æ™‚æ…‹)</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                        <div onclick="openLifeView('N5')" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3 active:scale-95 transition cursor-pointer">
                            <div class="w-8 h-8 rounded bg-orange-50 text-orange-500 flex items-center justify-center"><i class="fa-solid fa-toilet"></i></div>
                            <div class="flex-1">
                                <div class="font-bold text-sm">ç”Ÿæ´»åœ–é‘‘ (äº¤é€š/å»æ‰€/è²©è³£æ©Ÿ)</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Level N4 -->
                <div class="relative">
                    <span class="absolute -left-[25px] top-0 w-5 h-5 bg-green-500 rounded-full border-4 border-white shadow-sm"></span>
                    <h3 class="font-bold text-xl text-green-800 mb-2">Level N4 <span class="text-xs font-normal text-gray-500 ml-2">ç”Ÿæ´»æ‡‰ç”¨</span></h3>
                    <div class="space-y-2">
                         <div onclick="filterVocabByLevel('N4')" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3 active:scale-95 transition cursor-pointer">
                            <div class="w-8 h-8 rounded bg-pink-50 text-pink-500 flex items-center justify-center"><i class="fa-solid fa-list-ul"></i></div>
                            <div class="flex-1">
                                <div class="font-bold text-sm">N4 å–®å­—åº« (è‡ªä»–å‹•è©/è¡£ç‰©)</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                        <div onclick="openGrammarView('N4')" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3 active:scale-95 transition cursor-pointer">
                            <div class="w-8 h-8 rounded bg-green-50 text-green-500 flex items-center justify-center"><i class="fa-solid fa-shapes"></i></div>
                            <div class="flex-1">
                                <div class="font-bold text-sm">N4 é€²éšæ–‡æ³• (æ¢ä»¶/æˆå—/æ„å‘)</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                        <div onclick="openLifeView('N4')" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3 active:scale-95 transition cursor-pointer">
                            <div class="w-8 h-8 rounded bg-orange-50 text-orange-500 flex items-center justify-center"><i class="fa-solid fa-fan"></i></div>
                            <div class="flex-1">
                                <div class="font-bold text-sm">å®¶é›»èˆ‡è¨­å‚™ (é™æ§å™¨/ATM)</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Level N3 -->
                <div class="relative">
                    <span class="absolute -left-[25px] top-0 w-5 h-5 bg-purple-500 rounded-full border-4 border-white shadow-sm"></span>
                    <h3 class="font-bold text-xl text-purple-800 mb-2">Level N3 <span class="text-xs font-normal text-gray-500 ml-2">é€²éšæºé€š</span></h3>
                    <div class="space-y-2">
                        <div onclick="filterVocabByLevel('N3')" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3 active:scale-95 transition cursor-pointer">
                            <div class="w-8 h-8 rounded bg-pink-50 text-pink-500 flex items-center justify-center"><i class="fa-solid fa-list-ul"></i></div>
                            <div class="flex-1">
                                <div class="font-bold text-sm">N3 å–®å­—åº« (æŠ½è±¡/å•†å‹™/ç§‘æŠ€)</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                        <div onclick="openGrammarView('N3')" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3 active:scale-95 transition cursor-pointer">
                            <div class="w-8 h-8 rounded bg-green-50 text-green-500 flex items-center justify-center"><i class="fa-solid fa-shapes"></i></div>
                            <div class="flex-1">
                                <div class="font-bold text-sm">N3 æ‡‰ç”¨æ–‡æ³• (æ•¬èª/è¢«å‹•/ä½¿å½¹)</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                         <div onclick="openLifeView('N3')" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3 active:scale-95 transition cursor-pointer">
                            <div class="w-8 h-8 rounded bg-orange-50 text-orange-500 flex items-center justify-center"><i class="fa-solid fa-recycle"></i></div>
                            <div class="flex-1">
                                <div class="font-bold text-sm">ç¤¾æœƒè¦å‰‡ (ç§Ÿå±‹/å ±ç¨…/é†«ç™‚)</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: VOCAB (LIST STYLE) -->
        <div id="view-vocab" class="hidden space-y-4">
            <div class="flex justify-between items-center bg-white p-3 sticky top-0 z-10 shadow-sm border-b border-gray-100">
                 <button onclick="switchTab('roadmap')" class="text-sm text-gray-500 flex items-center gap-1"><i class="fa-solid fa-arrow-left"></i> è¿”å›</button>
                 <div class="flex-1 overflow-x-auto no-scrollbar mx-4" id="vocab-categories">
                    <!-- JS Populated Categories -->
                 </div>
                 <span id="vocab-level-badge" class="badge-n5 text-[10px] px-2 py-0.5 rounded-full font-bold whitespace-nowrap">N5</span>
            </div>
            
            <div id="vocab-list" class="space-y-2 pb-20 px-1">
                <!-- List items populated by JS -->
            </div>
        </div>

        <!-- VIEW: GRAMMAR -->
        <div id="view-grammar" class="hidden space-y-4">
            <div class="flex justify-between items-center bg-white p-3 sticky top-0 z-10 shadow-sm border-b border-gray-100">
                <button onclick="switchTab('roadmap')" class="text-sm text-gray-500 flex items-center gap-1"><i class="fa-solid fa-arrow-left"></i> è¿”å›</button>
                <span id="grammar-level-badge" class="badge-n5 text-[10px] px-2 py-0.5 rounded-full font-bold">N5</span>
            </div>
            <div id="grammar-list" class="space-y-4 pb-20 px-4"></div>
        </div>

        <!-- VIEW: LIFE, AI, KANA, QUIZ (Same layouts) -->
        <div id="view-life" class="hidden space-y-4">
            <div class="flex justify-between items-center mb-2 px-4 pt-2">
                <button onclick="switchTab('roadmap')" class="text-sm text-gray-500 flex items-center gap-1"><i class="fa-solid fa-arrow-left"></i> è¿”å›</button>
                <span id="life-level-badge" class="badge-n5 text-[10px] px-2 py-0.5 rounded-full font-bold">N5</span>
            </div>
            <div class="bg-orange-50 p-4 mx-4 rounded-xl border border-orange-100 mb-4">
                <h3 class="font-bold text-orange-800 flex items-center gap-2"><i class="fa-solid fa-circle-info"></i> åœ¨åœ°å°çŸ¥è­˜</h3>
                <p id="life-intro" class="text-sm text-orange-700 mt-1">äº†è§£æ—¥æœ¬é›»å™¨æŒ‰éˆ•èˆ‡æ¨™ç¤ºï¼Œç”Ÿæ´»æ›´ä¾¿åˆ©ï¼</p>
            </div>
            <div id="life-list" class="grid grid-cols-1 gap-4 pb-20 px-4"></div>
        </div>
        <div id="view-ai" class="hidden h-full flex flex-col">
            <div class="flex bg-gray-200 p-1 rounded-lg mb-4 shrink-0 mx-4 mt-2">
                <button onclick="setAiMode('sensei')" id="btn-mode-sensei" class="flex-1 py-1.5 text-xs font-bold rounded-md bg-white text-indigo-600 shadow transition-all">æƒ…å¢ƒå°å¸«</button>
                <button onclick="setAiMode('translator')" id="btn-mode-translator" class="flex-1 py-1.5 text-xs font-bold rounded-md text-gray-500 hover:bg-gray-50 transition-all">åœ–æ–‡ç¿»è­¯</button>
            </div>
            <div id="ai-mode-sensei" class="flex-1 flex flex-col h-full overflow-hidden px-4">
                <div class="mb-4 shrink-0">
                    <label class="block text-sm font-bold text-gray-700 mb-2">æƒ³å­¸ä»€éº¼æƒ…å¢ƒï¼Ÿ</label>
                    <textarea id="ai-prompt" class="w-full p-3 rounded-xl border border-gray-200 shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none text-sm resize-none h-20 mb-2" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³å»ç§‹è‘‰åŸè²·æ¨¡å‹ï¼Œæ•™æˆ‘æ€éº¼å•æœ‰æ²’æœ‰åº«å­˜..."></textarea>
                    <button onclick="callAiTeacher()" class="w-full bg-indigo-600 text-white rounded-lg py-2 text-sm font-bold shadow hover:bg-indigo-700 transition flex justify-center items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> ç”Ÿæˆè±å¯Œèª²ç¨‹</button>
                </div>
                <div id="sensei-result" class="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-20"><div id="sensei-placeholder" class="text-center text-gray-400 mt-10 text-sm">è¼¸å…¥æƒ…å¢ƒï¼ŒAI è€å¸«æ•™ä½ æœ€é“åœ°çš„èªªæ³•</div></div>
            </div>
            <div id="ai-mode-translator" class="hidden flex-1 flex flex-col h-full overflow-y-auto no-scrollbar pb-20 px-4">
                <div class="mb-4"><label class="block text-sm font-bold text-gray-700 mb-2">åœ–ç‰‡ç¿»è­¯</label><div class="relative"><input type="file" id="image-upload" accept="image/*" class="hidden" onchange="handleImageUpload(event)"><label for="image-upload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:bg-gray-50 transition bg-white" id="image-preview-container"><div class="flex flex-col items-center justify-center pt-5 pb-6 text-gray-400" id="upload-placeholder"><i class="fa-solid fa-camera text-2xl mb-2"></i><p class="text-xs">é»æ“Šæ‹ç…§æˆ–ä¸Šå‚³åœ–ç‰‡</p></div><img id="image-preview" class="hidden h-full w-full object-contain rounded-xl" /></label><button onclick="clearImage()" id="btn-clear-img" class="hidden absolute top-2 right-2 bg-gray-800/50 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs"><i class="fa-solid fa-xmark"></i></button></div></div>
                <div class="mb-4"><label class="block text-sm font-bold text-gray-700 mb-2">æ–‡å­—ç¿»è­¯</label><textarea id="trans-text-input" class="w-full p-3 rounded-xl border border-gray-200 shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none text-sm resize-none h-24" placeholder="è¼¸å…¥æ—¥æ–‡æˆ–ä¸­æ–‡..."></textarea></div>
                <button onclick="callAiTranslation()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl py-3 font-bold shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2"><i class="fa-solid fa-language"></i> ç«‹å³ç¿»è­¯</button>
                <div id="trans-loading" class="hidden mt-6 flex justify-center"><div class="loader-dots block relative w-20 h-5"><div class="absolute top-0 mt-1 w-3 h-3 rounded-full bg-indigo-500"></div><div class="absolute top-0 mt-1 w-3 h-3 rounded-full bg-indigo-500"></div><div class="absolute top-0 mt-1 w-3 h-3 rounded-full bg-indigo-500"></div><div class="absolute top-0 mt-1 w-3 h-3 rounded-full bg-indigo-500"></div></div></div>
                <div id="trans-result" class="hidden mt-6 bg-white p-5 rounded-xl shadow-sm border border-gray-100"><div class="flex justify-between items-start mb-2"><span class="text-xs font-bold text-indigo-500 uppercase">Result</span><button onclick="speakTransResult()" class="text-gray-400 hover:text-indigo-600"><i class="fa-solid fa-volume-high"></i></button></div><div id="trans-output-text" class="text-lg font-bold text-gray-800 mb-2"></div><div id="trans-output-romaji" class="text-sm text-gray-500 font-sans"></div></div>
            </div>
        </div>
        <div id="view-kana" class="hidden space-y-4 px-4 pt-2">
            <button onclick="switchTab('roadmap')" class="mb-2 text-sm text-gray-500 flex items-center gap-1"><i class="fa-solid fa-arrow-left"></i> è¿”å›</button>
            <div class="flex bg-white p-1 rounded-lg shadow-sm border border-gray-200">
                <button onclick="setKanaMode('hiragana')" id="btn-hiragana" class="flex-1 py-2 text-sm font-bold rounded-md bg-red-500 text-white shadow transition-all">å¹³å‡å (ã‚)</button>
                <button onclick="setKanaMode('katakana')" id="btn-katakana" class="flex-1 py-2 text-sm font-bold rounded-md text-gray-500 hover:bg-gray-50 transition-all">ç‰‡å‡å (ã‚¢)</button>
            </div>
            <div id="kana-grid" class="grid grid-cols-5 gap-2 pb-20"></div>
        </div>
        <div id="view-quiz" class="hidden h-full flex flex-col px-4">
            <div id="quiz-start" class="flex flex-col items-center justify-center h-full space-y-6">
                <div class="w-24 h-24 bg-purple-100 rounded-full flex items-center justify-center text-4xl text-purple-500 mb-2"><i class="fa-solid fa-graduation-cap"></i></div>
                <h2 class="text-2xl font-bold">æ¸¬é©—æŒ‘æˆ°</h2>
                <div class="w-3/4"><label class="block text-xs font-bold text-gray-500 mb-2 uppercase text-center">é¸æ“‡ç´šåˆ¥</label><select id="quiz-level-select" class="w-full p-3 rounded-xl border border-gray-200 bg-white text-center font-bold text-gray-700 outline-none focus:border-purple-500"><option value="ALL">å…¨éƒ¨ç´šåˆ¥ (ç¶œåˆ)</option><option value="N5">N5 å…¥é–€ç´š</option><option value="N4">N4 åŸºç¤ç´š</option><option value="N3">N3 é€²éšç´š</option></select></div>
                <button onclick="startQuiz()" class="bg-purple-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-purple-700 transition w-3/4">é–‹å§‹æ¸¬é©—</button>
            </div>
            <div id="quiz-active" class="hidden flex-col h-full mt-10">
                <div class="w-full bg-gray-200 rounded-full h-2 mb-6"><div id="quiz-progress" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div></div>
                <div class="flex-1 flex flex-col justify-center"><div class="text-center mb-8"><span id="quiz-badge" class="text-[10px] px-2 py-1 rounded bg-gray-200 text-gray-600 font-bold mb-2 inline-block">N5</span><h2 id="quiz-question" class="text-4xl font-bold font-jp text-gray-800 mt-2">çŒ«</h2></div><div id="quiz-options" class="space-y-3"></div></div>
                <div id="quiz-feedback" class="h-12 text-center font-bold mt-4 mb-20"></div>
            </div>
            <div id="quiz-result" class="hidden flex flex-col items-center justify-center h-full space-y-6"><div class="text-6xl mb-2" id="result-emoji">ğŸ‰</div><h2 class="text-2xl font-bold">æ¸¬é©—å®Œæˆï¼</h2><p class="text-xl">å¾—åˆ†: <span id="result-score" class="text-purple-600 font-bold">80</span> / 100</p><button onclick="resetQuizView()" class="bg-gray-800 text-white px-8 py-3 rounded-full font-bold shadow-lg mt-4 w-3/4">è¿”å›</button></div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bg-white border-t border-gray-200 fixed bottom-0 w-full z-20 pb-safe">
        <div class="flex justify-around items-center h-16">
            <button onclick="switchTab('home')" class="nav-item active flex-1 flex flex-col items-center justify-center text-gray-400 transition-colors" data-target="home"><i class="fa-solid fa-house text-xl mb-1"></i><span class="text-[10px]">é¦–é </span></button>
            <button onclick="switchTab('roadmap')" class="nav-item flex-1 flex flex-col items-center justify-center text-gray-400 transition-colors" data-target="roadmap"><i class="fa-solid fa-map-location-dot text-xl mb-1"></i><span class="text-[10px]">è·¯å¾‘</span></button>
            <button onclick="switchTab('ai')" class="nav-item flex-1 flex flex-col items-center justify-center text-gray-400 transition-colors" data-target="ai"><i class="fa-solid fa-robot text-xl mb-1"></i><span class="text-[10px]">AI</span></button>
            <button onclick="switchTab('quiz')" class="nav-item flex-1 flex flex-col items-center justify-center text-gray-400 transition-colors" data-target="quiz"><i class="fa-solid fa-clipboard-question text-xl mb-1"></i><span class="text-[10px]">æ¸¬é©—</span></button>
        </div>
    </nav>

    <!-- Javascript -->
    <script>
        // --- API CONFIGURATION ---
        const apiKey = ""; 
        
        // --- DATA ---
        const hiraganaData = [{ char: 'ã‚', romaji: 'a' }, { char: 'ã„', romaji: 'i' }, { char: 'ã†', romaji: 'u' }, { char: 'ãˆ', romaji: 'e' }, { char: 'ãŠ', romaji: 'o' }, { char: 'ã‹', romaji: 'ka' }, { char: 'ã', romaji: 'ki' }, { char: 'ã', romaji: 'ku' }, { char: 'ã‘', romaji: 'ke' }, { char: 'ã“', romaji: 'ko' }, { char: 'ã•', romaji: 'sa' }, { char: 'ã—', romaji: 'shi' }, { char: 'ã™', romaji: 'su' }, { char: 'ã›', romaji: 'se' }, { char: 'ã', romaji: 'so' }, { char: 'ãŸ', romaji: 'ta' }, { char: 'ã¡', romaji: 'chi' }, { char: 'ã¤', romaji: 'tsu' }, { char: 'ã¦', romaji: 'te' }, { char: 'ã¨', romaji: 'to' }, { char: 'ãª', romaji: 'na' }, { char: 'ã«', romaji: 'ni' }, { char: 'ã¬', romaji: 'nu' }, { char: 'ã­', romaji: 'ne' }, { char: 'ã®', romaji: 'no' }, { char: 'ã¯', romaji: 'ha' }, { char: 'ã²', romaji: 'hi' }, { char: 'ãµ', romaji: 'fu' }, { char: 'ã¸', romaji: 'he' }, { char: 'ã»', romaji: 'ho' }, { char: 'ã¾', romaji: 'ma' }, { char: 'ã¿', romaji: 'mi' }, { char: 'ã‚€', romaji: 'mu' }, { char: 'ã‚', romaji: 'me' }, { char: 'ã‚‚', romaji: 'mo' }, { char: 'ã‚„', romaji: 'ya' }, { char: '', romaji: '' }, { char: 'ã‚†', romaji: 'yu' }, { char: '', romaji: '' }, { char: 'ã‚ˆ', romaji: 'yo' }, { char: 'ã‚‰', romaji: 'ra' }, { char: 'ã‚Š', romaji: 'ri' }, { char: 'ã‚‹', romaji: 'ru' }, { char: 'ã‚Œ', romaji: 're' }, { char: 'ã‚', romaji: 'ro' }, { char: 'ã‚', romaji: 'wa' }, { char: '', romaji: '' }, { char: '', romaji: '' }, { char: '', romaji: '' }, { char: 'ã‚’', romaji: 'wo' }, { char: 'ã‚“', romaji: 'n' }, { char: '', romaji: '' }, { char: '', romaji: '' }, { char: '', romaji: '' }, { char: '', romaji: '' }];
        const katakanaData = [{ char: 'ã‚¢', romaji: 'a' }, { char: 'ã‚¤', romaji: 'i' }, { char: 'ã‚¦', romaji: 'u' }, { char: 'ã‚¨', romaji: 'e' }, { char: 'ã‚ª', romaji: 'o' }, { char: 'ã‚«', romaji: 'ka' }, { char: 'ã‚­', romaji: 'ki' }, { char: 'ã‚¯', romaji: 'ku' }, { char: 'ã‚±', romaji: 'ke' }, { char: 'ã‚³', romaji: 'ko' }, { char: 'ã‚µ', romaji: 'sa' }, { char: 'ã‚·', romaji: 'shi' }, { char: 'ã‚¹', romaji: 'su' }, { char: 'ã‚»', romaji: 'se' }, { char: 'ã‚½', romaji: 'so' }, { char: 'ã‚¿', romaji: 'ta' }, { char: 'ãƒ', romaji: 'chi' }, { char: 'ãƒ„', romaji: 'tsu' }, { char: 'ãƒ†', romaji: 'te' }, { char: 'ãƒˆ', romaji: 'to' }, { char: 'ãƒŠ', romaji: 'na' }, { char: 'ãƒ‹', romaji: 'ni' }, { char: 'ãƒŒ', romaji: 'nu' }, { char: 'ãƒ', romaji: 'ne' }, { char: 'ãƒ', romaji: 'no' }, { char: 'ãƒ', romaji: 'ha' }, { char: 'ãƒ’', romaji: 'hi' }, { char: 'ãƒ•', romaji: 'fu' }, { char: 'ãƒ˜', romaji: 'he' }, { char: 'ãƒ›', romaji: 'ho' }, { char: 'ãƒ', romaji: 'ma' }, { char: 'ãƒŸ', romaji: 'mi' }, { char: 'ãƒ ', romaji: 'mu' }, { char: 'ãƒ¡', romaji: 'me' }, { char: 'ãƒ¢', romaji: 'mo' }, { char: 'ãƒ¤', romaji: 'ya' }, { char: '', romaji: '' }, { char: 'ãƒ¦', romaji: 'yu' }, { char: '', romaji: '' }, { char: 'ãƒ¨', romaji: 'yo' }, { char: 'ãƒ©', romaji: 'ra' }, { char: 'ãƒª', romaji: 'ri' }, { char: 'ãƒ«', romaji: 'ru' }, { char: 'ãƒ¬', romaji: 're' }, { char: 'ãƒ­', romaji: 'ro' }, { char: 'ãƒ¯', romaji: 'wa' }, { char: '', romaji: '' }, { char: '', romaji: '' }, { char: '', romaji: '' }, { char: 'ãƒ²', romaji: 'wo' }, { char: 'ãƒ³', romaji: 'n' }, { char: '', romaji: '' }, { char: '', romaji: '' }, { char: '', romaji: '' }, { char: '', romaji: '' }];

        // === EXPANDED VOCABULARY DATA ===
        const vocabData = {
            // N5
            "n5_greetings": { level: "N5", label: "å•å€™", items: [
                { jp: "ã“ã‚“ã«ã¡ã¯", kana: "konnichiwa", mean: "ä½ å¥½" }, { jp: "ãŠã¯ã‚ˆã†", kana: "ohayou", mean: "æ—©å®‰" }, 
                { jp: "ã“ã‚“ã°ã‚“ã¯", kana: "konbanwa", mean: "æ™šå®‰" }, { jp: "ã•ã‚ˆã†ãªã‚‰", kana: "sayounara", mean: "å†è¦‹" }, 
                { jp: "ã‚ã‚ŠãŒã¨ã†", kana: "arigatou", mean: "è¬è¬" }, { jp: "ãŠã‚„ã™ã¿ãªã•ã„", kana: "oyasuminasai", mean: "æ™šå®‰(ç¡å‰)" },
                { jp: "ã„ãŸã ãã¾ã™", kana: "itadakimasu", mean: "æˆ‘ä¸å®¢æ°£äº†(é£¯å‰)" }, { jp: "ã”ã¡ãã†ã•ã¾", kana: "gochisousama", mean: "å¤šè¬æ¬¾å¾…(é£¯å¾Œ)" },
                { jp: "ã™ã¿ã¾ã›ã‚“", kana: "sumimasen", mean: "ä¸å¥½æ„æ€" }, { jp: "ã¯ã˜ã‚ã¾ã—ã¦", kana: "hajimemashite", mean: "åˆæ¬¡è¦‹é¢" }
            ]},
            "n5_numbers": { level: "N5", label: "æ•¸å­—/æ™‚é–“", items: [
                { jp: "ä¸€", kana: "ichi", mean: "1" }, { jp: "äºŒ", kana: "ni", mean: "2" }, { jp: "ä¸‰", kana: "san", mean: "3" },
                { jp: "å››", kana: "yon", mean: "4" }, { jp: "äº”", kana: "go", mean: "5" }, { jp: "å…­", kana: "roku", mean: "6" },
                { jp: "ä¸ƒ", kana: "nana", mean: "7" }, { jp: "å…«", kana: "hachi", mean: "8" }, { jp: "ä¹", kana: "kyuu", mean: "9" },
                { jp: "å", kana: "juu", mean: "10" }, { jp: "ç™¾", kana: "hyaku", mean: "100" }, { jp: "åƒ", kana: "sen", mean: "1000" },
                { jp: "ä¸‡", kana: "man", mean: "10000" }, { jp: "ä»Š", kana: "ima", mean: "ç¾åœ¨" }, { jp: "æ˜æ—¥", kana: "ashita", mean: "æ˜å¤©" },
                { jp: "æ˜¨æ—¥", kana: "kinou", mean: "æ˜¨å¤©" }, { jp: "ä»Šæ—¥", kana: "kyou", mean: "ä»Šå¤©" }, { jp: "æ¯æ—¥", kana: "mainichi", mean: "æ¯å¤©" },
                { jp: "æœ", kana: "asa", mean: "æ—©ä¸Š" }, { jp: "æ˜¼", kana: "hiru", mean: "ä¸­åˆ" }, { jp: "æ™©", kana: "ban", mean: "æ™šä¸Š" }
            ]},
            "n5_family": { level: "N5", label: "äººèˆ‡å®¶åº­", items: [
                { jp: "ç§", kana: "watashi", mean: "æˆ‘" }, { jp: "ã‚ãªãŸ", kana: "anata", mean: "ä½ " },
                { jp: "çˆ¶", kana: "chichi", mean: "çˆ¶è¦ª(è‡ªç¨±)" }, { jp: "æ¯", kana: "haha", mean: "æ¯è¦ª(è‡ªç¨±)" },
                { jp: "ãŠçˆ¶ã•ã‚“", kana: "otousan", mean: "çˆ¸çˆ¸(ç¨±å‘¼)" }, { jp: "ãŠæ¯ã•ã‚“", kana: "okaasan", mean: "åª½åª½(ç¨±å‘¼)" },
                { jp: "å…„", kana: "ani", mean: "å“¥å“¥" }, { jp: "å§‰", kana: "ane", mean: "å§Šå§Š" },
                { jp: "å¦¹", kana: "imouto", mean: "å¦¹å¦¹" }, { jp: "å¼Ÿ", kana: "otouto", mean: "å¼Ÿå¼Ÿ" },
                { jp: "å‹é”", kana: "tomodachi", mean: "æœ‹å‹" }, { jp: "å…ˆç”Ÿ", kana: "sensei", mean: "è€å¸«" }, { jp: "å­¦ç”Ÿ", kana: "gakusei", mean: "å­¸ç”Ÿ" }
            ]},
            "n5_verbs": { level: "N5", label: "æ—¥å¸¸å‹•è©", items: [
                { jp: "é£Ÿã¹ã¾ã™", kana: "tabemasu", mean: "åƒ" }, { jp: "é£²ã¿ã¾ã™", kana: "nomimasu", mean: "å–" },
                { jp: "è¡Œãã¾ã™", kana: "ikimasu", mean: "å»" }, { jp: "æ¥ã¾ã™", kana: "kimasu", mean: "ä¾†" },
                { jp: "å¸°ã‚Šã¾ã™", kana: "kaerimasu", mean: "å›å®¶" }, { jp: "è¦‹ã¾ã™", kana: "mimasu", mean: "çœ‹" },
                { jp: "èãã¾ã™", kana: "kikimasu", mean: "è½" }, { jp: "èª­ã¿ã¾ã™", kana: "yomimasu", mean: "è®€" },
                { jp: "æ›¸ãã¾ã™", kana: "kakimasu", mean: "å¯«" }, { jp: "è©±ã—ã¾ã™", kana: "hanashimasu", mean: "èªª" },
                { jp: "è²·ã„ã¾ã™", kana: "kaimasu", mean: "è²·" }, { jp: "å¯ã¾ã™", kana: "nemasu", mean: "ç¡è¦º" },
                { jp: "èµ·ãã¾ã™", kana: "okimasu", mean: "èµ·åºŠ" }, { jp: "ã—ã¾ã™", kana: "shimasu", mean: "åš" }
            ]},
            "n5_adjectives": { level: "N5", label: "å½¢å®¹è©", items: [
                { jp: "å¤§ãã„", kana: "ookii", mean: "å¤§çš„" }, { jp: "å°ã•ã„", kana: "chiisai", mean: "å°çš„" },
                { jp: "é«˜ã„", kana: "takai", mean: "è²´çš„/é«˜çš„" }, { jp: "å®‰ã„", kana: "yasui", mean: "ä¾¿å®œçš„" },
                { jp: "æ–°ã—ã„", kana: "atarashii", mean: "æ–°çš„" }, { jp: "å¤ã„", kana: "furui", mean: "èˆŠçš„" },
                { jp: "è‰¯ã„", kana: "ii", mean: "å¥½çš„" }, { jp: "æ‚ªã„", kana: "warui", mean: "å£çš„" },
                { jp: "ãŠã„ã—ã„", kana: "oishii", mean: "å¥½åƒçš„" }, { jp: "å¿™ã—ã„", kana: "isogashii", mean: "å¿™ç¢Œçš„" },
                { jp: "æ¥½ã—ã„", kana: "tanoshii", mean: "å¿«æ¨‚çš„" }, { jp: "ãã‚Œã„", kana: "kirei", mean: "æ¼‚äº®çš„/ä¹¾æ·¨çš„" },
                { jp: "é™ã‹", kana: "shizuka", mean: "å®‰éœçš„" }, { jp: "å…ƒæ°—", kana: "genki", mean: "æœ‰ç²¾ç¥çš„" }
            ]},
            "n5_places": { level: "N5", label: "ä½ç½®/å ´æ‰€", items: [
                { jp: "ä¸Š", kana: "ue", mean: "ä¸Šé¢" }, { jp: "ä¸‹", kana: "shita", mean: "ä¸‹é¢" },
                { jp: "å‰", kana: "mae", mean: "å‰é¢" }, { jp: "å¾Œã‚", kana: "ushiro", mean: "å¾Œé¢" },
                { jp: "ä¸­", kana: "naka", mean: "è£¡é¢" }, { jp: "å¤–", kana: "soto", mean: "å¤–é¢" },
                { jp: "å­¦æ ¡", kana: "gakkou", mean: "å­¸æ ¡" }, { jp: "ä¼šç¤¾", kana: "kaisha", mean: "å…¬å¸" },
                { jp: "ç—…é™¢", kana: "byouin", mean: "é†«é™¢" }, { jp: "ãƒˆã‚¤ãƒ¬", kana: "toire", mean: "å»æ‰€" }
            ]},

            // N4
            "n4_body": { level: "N4", label: "èº«é«”/å¥åº·", items: [
                { jp: "é ­", kana: "atama", mean: "é ­" }, { jp: "ç›®", kana: "me", mean: "çœ¼ç›" },
                { jp: "è€³", kana: "mimi", mean: "è€³æœµ" }, { jp: "å£", kana: "kuchi", mean: "å˜´å·´" },
                { jp: "æ‰‹", kana: "te", mean: "æ‰‹" }, { jp: "è¶³", kana: "ashi", mean: "è…³" },
                { jp: "ãŠè…¹", kana: "onaka", mean: "è‚šå­" }, { jp: "ç—›ã„", kana: "itai", mean: "ç—›" },
                { jp: "é¢¨é‚ª", kana: "kaze", mean: "æ„Ÿå†’" }, { jp: "ç†±", kana: "netsu", mean: "ç™¼ç‡’" },
                { jp: "è–¬", kana: "kusuri", mean: "è—¥" }, { jp: "ç—…é™¢", kana: "byouin", mean: "é†«é™¢" }
            ]},
            "n4_weather": { level: "N4", label: "å¤©æ°£/å­£ç¯€", items: [
                { jp: "æ™´ã‚Œ", kana: "hare", mean: "æ™´å¤©" }, { jp: "é›¨", kana: "ame", mean: "é›¨å¤©" },
                { jp: "é›ª", kana: "yuki", mean: "é›ª" }, { jp: "æ›‡ã‚Š", kana: "kumori", mean: "é™°å¤©" },
                { jp: "é¢¨", kana: "kaze", mean: "é¢¨" }, { jp: "æ˜¥", kana: "haru", mean: "æ˜¥å¤©" },
                { jp: "å¤", kana: "natsu", mean: "å¤å¤©" }, { jp: "ç§‹", kana: "aki", mean: "ç§‹å¤©" },
                { jp: "å†¬", kana: "fuyu", mean: "å†¬å¤©" }, { jp: "å°é¢¨", kana: "taifuu", mean: "é¢±é¢¨" }
            ]},
            "n4_town": { level: "N4", label: "åŸé®/äº¤é€š", items: [
                { jp: "é§…", kana: "eki", mean: "è»Šç«™" }, { jp: "é›»è»Š", kana: "densha", mean: "é›»è»Š" },
                { jp: "åœ°ä¸‹é‰„", kana: "chikatetsu", mean: "åœ°ä¸‹éµ" }, { jp: "ãƒã‚¹", kana: "basu", mean: "å…¬è»Š" },
                { jp: "è‡ªè»¢è»Š", kana: "jitensha", mean: "è…³è¸è»Š" }, { jp: "ç©ºæ¸¯", kana: "kuukou", mean: "æ©Ÿå ´" },
                { jp: "é£›è¡Œæ©Ÿ", kana: "hikouki", mean: "é£›æ©Ÿ" }, { jp: "åœ°å›³", kana: "chizu", mean: "åœ°åœ–" },
                { jp: "äº¤ç•ª", kana: "kouban", mean: "æ´¾å‡ºæ‰€" }, { jp: "éŠ€è¡Œ", kana: "ginkou", mean: "éŠ€è¡Œ" },
                { jp: "éƒµä¾¿å±€", kana: "yuubinkyoku", mean: "éƒµå±€" }, { jp: "å›³æ›¸é¤¨", kana: "toshokan", mean: "åœ–æ›¸é¤¨" }
            ]},
            "n4_clothing": { level: "N4", label: "è¡£ç‰©/ç©¿è‘—", items: [
                { jp: "æœ", kana: "fuku", mean: "è¡£æœ" }, { jp: "ç€ã¾ã™", kana: "kimasu", mean: "ç©¿(ä¸ŠåŠèº«)" },
                { jp: "å±¥ãã¾ã™", kana: "hakimasu", mean: "ç©¿(ä¸‹åŠèº«/é‹)" }, { jp: "ã‹ã¶ã‚Šã¾ã™", kana: "kaburimasu", mean: "æˆ´(å¸½å­)" },
                { jp: "é´", kana: "kutsu", mean: "é‹å­" }, { jp: "é´ä¸‹", kana: "kutsushita", mean: "è¥ªå­" },
                { jp: "å¸½å­", kana: "boushi", mean: "å¸½å­" }, { jp: "çœ¼é¡", kana: "megane", mean: "çœ¼é¡" },
                { jp: "è„±ãã¾ã™", kana: "nugimasu", mean: "è„«" }
            ]},
            "n4_verbs_pairs": { level: "N4", label: "è‡ªä»–å‹•è©", items: [
                { jp: "é–‹ã‘ã¾ã™", kana: "akemasu", mean: "æ‰“é–‹(ä»–)" }, { jp: "é–‹ãã¾ã™", kana: "akimasu", mean: "é–‹è‘—(è‡ª)" },
                { jp: "é–‰ã‚ã¾ã™", kana: "shimemasu", mean: "é—œä¸Š(ä»–)" }, { jp: "é–‰ã¾ã‚Šã¾ã™", kana: "shimarimasu", mean: "é—œè‘—(è‡ª)" },
                { jp: "ç‚¹ã‘ã¾ã™", kana: "tsukemasu", mean: "æ‰“é–‹é›»å™¨(ä»–)" }, { jp: "ç‚¹ãã¾ã™", kana: "tsukimasu", mean: "äº®è‘—(è‡ª)" },
                { jp: "æ¶ˆã—ã¾ã™", kana: "keshimasu", mean: "é—œæ‰é›»å™¨(ä»–)" }, { jp: "æ¶ˆãˆã¾ã™", kana: "kiemasu", mean: "ç†„æ»…(è‡ª)" },
                { jp: "å£Šã—ã¾ã™", kana: "kowashimasu", mean: "å¼„å£(ä»–)" }, { jp: "å£Šã‚Œã¾ã™", kana: "kowaremasu", mean: "å£æ‰(è‡ª)" }
            ]},

            // N3
            "n3_business": { level: "N3", label: "å•†å‹™/å·¥ä½œ", items: [
                { jp: "ä¼šç¤¾", kana: "kaisha", mean: "å…¬å¸" }, { jp: "ä¼šè­°", kana: "kaigi", mean: "æœƒè­°" },
                { jp: "ç¤¾é•·", kana: "shachou", mean: "ç¤¾é•·" }, { jp: "éƒ¨é•·", kana: "buchou", mean: "éƒ¨é•·" },
                { jp: "èª²é•·", kana: "kachou", mean: "èª²é•·" }, { jp: "åŒåƒš", kana: "douryou", mean: "åŒäº‹" },
                { jp: "æ®‹æ¥­", kana: "zangyou", mean: "åŠ ç­" }, { jp: "å‡ºå¼µ", kana: "shucchou", mean: "å‡ºå·®" },
                { jp: "æ›¸é¡", kana: "shorui", mean: "æ–‡ä»¶" }, { jp: "çµ¦æ–™", kana: "kyuuryou", mean: "è–ªæ°´" },
                { jp: "æŒ¨æ‹¶", kana: "aisatsu", mean: "å•å€™" }, { jp: "é€£çµ¡", kana: "renraku", mean: "è¯çµ¡" }
            ]},
            "n3_emotions": { level: "N3", label: "æƒ…æ„Ÿ/æ€§æ ¼", items: [
                { jp: "å¬‰ã—ã„", kana: "ureshii", mean: "é«˜èˆˆçš„" }, { jp: "æ‚²ã—ã„", kana: "kanashii", mean: "æ‚²å‚·çš„" },
                { jp: "å¯‚ã—ã„", kana: "sabishii", mean: "å¯‚å¯çš„" }, { jp: "æ¥ãšã‹ã—ã„", kana: "hazukashii", mean: "å®³ç¾/ä¸Ÿè‡‰" },
                { jp: "æ€’ã‚‹", kana: "okoru", mean: "ç”Ÿæ°£" }, { jp: "é©šã", kana: "odoroku", mean: "é©šè¨" },
                { jp: "çœŸé¢ç›®", kana: "majime", mean: "èªçœŸçš„" }, { jp: "å„ªã—ã„", kana: "yasashii", mean: "æº«æŸ”çš„" },
                { jp: "å³ã—ã„", kana: "kibishii", mean: "åš´æ ¼çš„" }, { jp: "æˆ‘æ…¢", kana: "gaman", mean: "å¿è€" }
            ]},
            "n3_abstract": { level: "N3", label: "æŠ½è±¡æ¦‚å¿µ", items: [
                { jp: "å¹³å’Œ", kana: "heiwa", mean: "å’Œå¹³" }, { jp: "æˆ¦äº‰", kana: "sensou", mean: "æˆ°çˆ­" },
                { jp: "è‡ªç”±", kana: "jiyuu", mean: "è‡ªç”±" }, { jp: "è²¬ä»»", kana: "sekinin", mean: "è²¬ä»»" },
                { jp: "æ³•å¾‹", kana: "houritsu", mean: "æ³•å¾‹" }, { jp: "çµŒæ¸ˆ", kana: "keizai", mean: "ç¶“æ¿Ÿ" },
                { jp: "æ”¿æ²»", kana: "seiji", mean: "æ”¿æ²»" }, { jp: "æ–‡åŒ–", kana: "bunka", mean: "æ–‡åŒ–" },
                { jp: "å°†æ¥", kana: "shourai", mean: "å°‡ä¾†" }, { jp: "å¤¢", kana: "yume", mean: "å¤¢æƒ³" }
            ]},
            "n3_it": { level: "N3", label: "IT/ç§‘æŠ€", items: [
                { jp: "ãƒ‘ã‚½ã‚³ãƒ³", kana: "pasokon", mean: "å€‹äººé›»è…¦" }, { jp: "ç”»é¢", kana: "gamen", mean: "è¢å¹•" },
                { jp: "å…¥åŠ›", kana: "nyuuryoku", mean: "è¼¸å…¥" }, { jp: "ä¿å­˜", kana: "hozon", mean: "å­˜æª”" },
                { jp: "å‰Šé™¤", kana: "sakujo", mean: "åˆªé™¤" }, { jp: "æ¤œç´¢", kana: "kensaku", mean: "æœå°‹" },
                { jp: "é€ä¿¡", kana: "soushin", mean: "å‚³é€" }, { jp: "å—ä¿¡", kana: "jushin", mean: "æ¥æ”¶" }
            ]},
            "n3_conjunctions": { level: "N3", label: "é€£æ¥è©/å‰¯è©", items: [
                { jp: "ä¾‹ãˆã°", kana: "tatoeba", mean: "ä¾‹å¦‚" }, { jp: "å®Ÿã¯", kana: "jitsuwa", mean: "å…¶å¯¦" },
                { jp: "å¿…ãš", kana: "kanarazu", mean: "ä¸€å®š/å‹™å¿…" }, { jp: "çµ¶å¯¾ã«", kana: "zettaini", mean: "çµ•å°" },
                { jp: "ã‚„ã¯ã‚Š", kana: "yahari", mean: "æœç„¶" }, { jp: "ã—ã‹ã—", kana: "shikashi", mean: "ä½†æ˜¯" },
                { jp: "ã¾ãŸã¯", kana: "matawa", mean: "æˆ–è€…" }, { jp: "ã¤ã¾ã‚Š", kana: "tsumari", mean: "ä¹Ÿå°±æ˜¯èªª" }
            ]}
        };

        // === EXPANDED GRAMMAR DATA ===
        const grammarData = {
            "N5": [
                { title: "ï½ã¯ï½ã§ã™", mean: "A æ˜¯ B", desc: "æœ€åŸºç¤çš„å¥å‹ï¼Œè¡¨ç¤ºã€Œ...æ˜¯...ã€ã€‚", ex: "ç§ã¯å­¦ç”Ÿã§ã™ã€‚", ex_mean: "æˆ‘æ˜¯å­¸ç”Ÿã€‚" },
                { title: "ï½ã‹", mean: "ç–‘å•å¥", desc: "æ”¾åœ¨å¥å°¾è¡¨ç¤ºç–‘å•ã€‚", ex: "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ã€‚", ex_mean: "å»æ‰€åœ¨å“ªè£¡ï¼Ÿ" },
                { title: "ï½ã®ï½", mean: "ï½çš„ï½", desc: "è¡¨ç¤ºæ‰€å±¬é—œä¿‚ã€‚", ex: "ç§ã®æœ¬", ex_mean: "æˆ‘çš„æ›¸" },
                { title: "ï½ã«ï½ãŒã‚ã‚Šã¾ã™", mean: "åœ¨...æœ‰...", desc: "è¡¨ç¤ºç‰©é«”çš„å­˜åœ¨ã€‚", ex: "éƒ¨å±‹ã«æœºãŒã‚ã‚Šã¾ã™ã€‚", ex_mean: "æˆ¿é–“è£¡æœ‰æ¡Œå­ã€‚" },
                { title: "ï½ã¸è¡Œãã¾ã™", mean: "å»...", desc: "è¡¨ç¤ºç§»å‹•æ–¹å‘ã€‚", ex: "å­¦æ ¡ã¸è¡Œãã¾ã™ã€‚", ex_mean: "å»å­¸æ ¡ã€‚" },
                { title: "ï½ã‚’ï½ã¾ã™", mean: "åšæŸå‹•ä½œ", desc: "ä»–å‹•è©å¥å‹ï¼Œè¡¨ç¤ºå‹•ä½œå°è±¡ã€‚", ex: "ã”é£¯ã‚’é£Ÿã¹ã¾ã™ã€‚", ex_mean: "åƒé£¯ã€‚" },
                { title: "ï½ãŸã„ã§ã™", mean: "æƒ³åš...", desc: "è¡¨ç¤ºç¬¬ä¸€äººç¨±çš„é¡˜æœ›ã€‚", ex: "æ—¥æœ¬ã¸è¡ŒããŸã„ã§ã™ã€‚", ex_mean: "æƒ³å»æ—¥æœ¬ã€‚" },
                { title: "ï½ã¦ãã ã•ã„", mean: "è«‹åš...", desc: "è¡¨ç¤ºè«‹æ±‚ã€æŒ‡ç¤ºã€‚", ex: "ã¡ã‚‡ã£ã¨å¾…ã£ã¦ãã ã•ã„ã€‚", ex_mean: "è«‹ç¨ç­‰ä¸€ä¸‹ã€‚" },
                { title: "ï½ãªã„ã§ãã ã•ã„", mean: "è«‹ä¸è¦...", desc: "è¡¨ç¤ºç¦æ­¢ã€è«‹æ±‚ä¸è¦åšã€‚", ex: "å†™çœŸã‚’æ’®ã‚‰ãªã„ã§ãã ã•ã„ã€‚", ex_mean: "è«‹ä¸è¦æ‹ç…§ã€‚" },
                { title: "ï½ã¦ã‚‚ã„ã„ã§ã™", mean: "å¯ä»¥...", desc: "è¡¨ç¤ºè¨±å¯ã€‚", ex: "å…¥ã£ã¦ã‚‚ã„ã„ã§ã™ã‹ã€‚", ex_mean: "å¯ä»¥é€²ä¾†å—ï¼Ÿ" },
                { title: "ï½ã¦ã„ã¾ã™", mean: "æ­£åœ¨...", desc: "è¡¨ç¤ºå‹•ä½œæ­£åœ¨é€²è¡Œä¸­ã€‚", ex: "ä»Šã€å‹‰å¼·ã—ã¦ã„ã¾ã™ã€‚", ex_mean: "ç¾åœ¨æ­£åœ¨å”¸æ›¸ã€‚" },
                { title: "å½¢å®¹è©å¦å®š (ããªã„)", mean: "ä¸...", desc: "ã„å½¢å®¹è©çš„å¦å®šè®ŠåŒ–ã€‚", ex: "ä»Šæ—¥ã¯æš‘ããªã„ã§ã™ã€‚", ex_mean: "ä»Šå¤©ä¸ç†±ã€‚" }
            ],
            "N4": [
                { title: "ï½ã¦ã‹ã‚‰", mean: "åšå®Œ...ä¹‹å¾Œ", desc: "è¡¨ç¤ºå‹•ä½œçš„é †åºã€‚", ex: "æ‰‹ã‚’æ´—ã£ã¦ã‹ã‚‰é£Ÿã¹ã¾ã™ã€‚", ex_mean: "æ´—æ‰‹å¾Œå†åƒã€‚" },
                { title: "ï½ã“ã¨ãŒã§ãã¾ã™", mean: "èƒ½å¤ ...", desc: "è¡¨ç¤ºèƒ½åŠ›æˆ–å¯èƒ½æ€§ã€‚", ex: "æ—¥æœ¬èªã‚’è©±ã™ã“ã¨ãŒã§ãã¾ã™ã€‚", ex_mean: "æœƒèªªæ—¥èªã€‚" },
                { title: "ï½ãŸã“ã¨ãŒã‚ã‚Šã¾ã™", mean: "æ›¾ç¶“...", desc: "è¡¨ç¤ºéå»çš„ç¶“é©—ã€‚", ex: "å¯¿å¸ã‚’é£Ÿã¹ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚", ex_mean: "åƒéå£½å¸ã€‚" },
                { title: "ï½ãŸã‚Šï½ãŸã‚Š", mean: "åˆ...åˆ...", desc: "åˆ—èˆ‰æ²’æœ‰é †åºçš„å‹•ä½œã€‚", ex: "é€±æœ«ã¯æ˜ ç”»ã‚’è¦‹ãŸã‚Šã€æœ¬ã‚’èª­ã‚“ã ã‚Šã—ã¾ã™ã€‚", ex_mean: "é€±æœ«æœƒçœ‹çœ‹é›»å½±ã€è®€è®€æ›¸ã€‚" },
                { title: "ï½ã¨æ€ã„ã¾ã™", mean: "æˆ‘æƒ³...", desc: "è¡¨ç¤ºèªªè©±è€…çš„æ¨æ¸¬æˆ–æ„è¦‹ã€‚", ex: "æ˜æ—¥ã¯é›¨ã ã¨æ€ã„ã¾ã™ã€‚", ex_mean: "æˆ‘æƒ³æ˜å¤©æœƒä¸‹é›¨ã€‚" },
                { title: "ï½ã¨è¨€ã„ã¾ã—ãŸ", mean: "èªªäº†...", desc: "å¼•ç”¨ä»–äººçš„è©±èªã€‚", ex: "å½¼ã¯ã€Œå¥½ãã€ã¨è¨€ã„ã¾ã—ãŸã€‚", ex_mean: "ä»–èªªäº†ã€Œå–œæ­¡ã€ã€‚" },
                { title: "ï½ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“", mean: "å¿…é ˆ...", desc: "è¡¨ç¤ºç¾©å‹™ã€å¿…è¦æ€§ã€‚", ex: "è–¬ã‚’é£²ã¾ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚", ex_mean: "å¿…é ˆåƒè—¥ã€‚" },
                { title: "ï½ã§ã—ã‚‡ã†", mean: "...å§ï¼Ÿ", desc: "ç¢ºèªæˆ–æ¨æ¸¬ã€‚", ex: "ãã®æ˜ ç”»ã¯é¢ç™½ã„ã§ã—ã‚‡ã†ã€‚", ex_mean: "é‚£éƒ¨é›»å½±å¾ˆæœ‰è¶£å§ã€‚" },
                { title: "ï½ã¤ã‚‚ã‚Šã§ã™", mean: "æ‰“ç®—...", desc: "è¡¨ç¤ºæ„å¿—æˆ–è¨ˆç•«ã€‚", ex: "æ¥å¹´ã€ç•™å­¦ã™ã‚‹ã¤ã‚‚ã‚Šã§ã™ã€‚", ex_mean: "æ‰“ç®—æ˜å¹´å»ç•™å­¸ã€‚" },
                { title: "ï½ã»ã†ãŒã„ã„ã§ã™", mean: "æœ€å¥½...", desc: "è¡¨ç¤ºå»ºè­°ã€‚", ex: "æ—©ãå¯ãŸã»ã†ãŒã„ã„ã§ã™ã€‚", ex_mean: "æœ€å¥½æ—©é»ç¡ã€‚" },
                { title: "å¯èƒ½å½¢ (ï½ã‚Œã‚‹)", mean: "èƒ½...", desc: "å‹•è©çš„å¯èƒ½å½¢è®ŠåŒ–ã€‚", ex: "æ¼¢å­—ãŒæ›¸ã‘ã¾ã™ã€‚", ex_mean: "æœƒå¯«æ¼¢å­—ã€‚" },
                { title: "ï½ãã†ã§ã™ (æ¨£æ…‹)", mean: "çœ‹èµ·ä¾†...", desc: "æ ¹æ“šå¤–è§€çš„æ¨æ¸¬ã€‚", ex: "ã“ã®ã‚±ãƒ¼ã‚­ã¯ç¾å‘³ã—ãã†ã§ã™ã€‚", ex_mean: "é€™è›‹ç³•çœ‹èµ·ä¾†å¾ˆå¥½åƒã€‚" }
            ],
            "N3": [
                { title: "ï½ã¦ã‚‚", mean: "å³ä½¿...ä¹Ÿ...", desc: "é€†æ¥æ¢ä»¶ã€‚", ex: "é›¨ãŒé™ã£ã¦ã‚‚è¡Œãã¾ã™ã€‚", ex_mean: "å³ä½¿ä¸‹é›¨ä¹Ÿè¦å»ã€‚" },
                { title: "ï½ã«å¯¾ã—ã¦", mean: "å°æ–¼...", desc: "è¡¨ç¤ºå‹•ä½œçš„å°è±¡ã€‚", ex: "ãŠå®¢æ§˜ã«å¯¾ã—ã¦æ•¬èªã‚’ä½¿ã„ã¾ã™ã€‚", ex_mean: "å°å®¢äººä½¿ç”¨æ•¬èªã€‚" },
                { title: "ï½ã¨ã„ã†", mean: "å«åš...", desc: "å®šç¾©åç¨±æˆ–å…§å®¹ã€‚", ex: "ã“ã‚Œã¯ã€Œç´è±†ã€ã¨ã„ã†é£Ÿã¹ç‰©ã§ã™ã€‚", ex_mean: "é€™æ˜¯ä¸€ç¨®å«ã€Œç´è±†ã€çš„é£Ÿç‰©ã€‚" },
                { title: "ï½ã«ã‚ˆã£ã¦", mean: "ç”±.../æ ¹æ“š...", desc: "è¡¨ç¤ºåŸå› ã€æ‰‹æ®µæˆ–è¢«å‹•çš„ä¸»é«”ã€‚", ex: "å°é¢¨ã«ã‚ˆã£ã¦æœ¨ãŒå€’ã‚ŒãŸã€‚", ex_mean: "å› ç‚ºé¢±é¢¨æ¨¹å€’äº†ã€‚" },
                { title: "ï½ã°ã‹ã‚Š", mean: "å…‰æ˜¯.../ç›¡æ˜¯...", desc: "è¡¨ç¤ºæŸå‹•ä½œé »ç‡æ¥µé«˜ã€‚", ex: "éŠã‚“ã§ã°ã‹ã‚Šã„ãªã„ã§ãã ã•ã„ã€‚", ex_mean: "ä¸è¦å…‰æ˜¯ç©ã€‚" },
                { title: "ï½ã¾ã¾", mean: "ä¿æŒ...ç‹€æ…‹", desc: "ç¶­æŒåŸæ¨£ã€‚", ex: "é´ã‚’å±¥ã„ãŸã¾ã¾å…¥ã£ã¦ãã ã•ã„ã€‚", ex_mean: "è«‹ç©¿è‘—é‹å­é€²ä¾†ã€‚" },
                { title: "ï½ã‚‰ã—ã„", mean: "å¥½åƒ.../æœ‰...çš„æ¨£å­", desc: "æ ¹æ“šå‚³èæ¨æ¸¬æˆ–å…¸å‹ç‰¹è³ªã€‚", ex: "å½¼ã¯æ¥ãªã„ã‚‰ã—ã„ã€‚", ex_mean: "ä»–å¥½åƒä¸æœƒä¾†ã€‚" },
                { title: "ä½¿å½¹å½¢ (ï½ã•ã›ã‚‹)", mean: "è®“...åš", desc: "è¡¨ç¤ºå¼·åˆ¶æˆ–è¨±å¯ã€‚", ex: "æ¯ã¯å­ä¾›ã«é‡èœã‚’é£Ÿã¹ã•ã›ã¾ã™ã€‚", ex_mean: "åª½åª½è®“å­©å­åƒè”¬èœã€‚" },
                { title: "å—èº«å½¢ (ï½ã‚Œã‚‹)", mean: "è¢«...", desc: "è¡¨ç¤ºè¢«å‹•ã€‚", ex: "è¶³ã‚’è¸ã¾ã‚Œã¾ã—ãŸã€‚", ex_mean: "è…³è¢«è¸©äº†ã€‚" },
                { title: "ï½ã¯ãšã§ã™", mean: "æ‡‰è©²...", desc: "æœ‰æ ¹æ“šçš„æ¨æ¸¬ã€‚", ex: "å½¼ã¯ã‚‚ã†ç€ãã¯ãšã§ã™ã€‚", ex_mean: "ä»–æ‡‰è©²å·²ç¶“åˆ°äº†ã€‚" },
                { title: "ï½ãŸã‚ã«", mean: "ç‚ºäº†...", desc: "è¡¨ç¤ºç›®çš„æˆ–åŸå› ã€‚", ex: "å®¶æ—ã®ãŸã‚ã«åƒãã¾ã™ã€‚", ex_mean: "ç‚ºäº†å®¶äººå·¥ä½œã€‚" },
                { title: "ï½ãŠã‹ã’ã§", mean: "å¤šè™§...", desc: "è¡¨ç¤ºæ­£é¢çš„åŸå› ã€‚", ex: "å…ˆç”Ÿã®ãŠã‹ã’ã§åˆæ ¼ã—ã¾ã—ãŸã€‚", ex_mean: "å¤šè™§è€å¸«ï¼Œæˆ‘åˆæ ¼äº†ã€‚" }
            ]
        };

        const lifeData = {
            "N5": [
                { title: "å…æ²»é¦¬æ¡¶", desc: "æ—¥æœ¬å»æ‰€æŒ‰éˆ•", items: ["ãŠã—ã‚Š (æ´—å±å±)", "ãƒ“ãƒ‡ (å¥³æ€§ç”¨)", "æ­¢ (åœæ­¢)", "æµã™ (æ²–æ°´)", "å¤§/å° (æ°´é‡)"] },
                { title: "è‡ªå‹•è²©è³£æ©Ÿ", desc: "å†·ç†±é£²æ¨™ç¤º", items: ["ã¤ã‚ãŸã„ (å†·é£²-è—)", "ã‚ãŸãŸã‹ã„ (ç†±é£²-ç´…)", "å£²åˆ‡ (å”®å®Œ)", "æº–å‚™ä¸­ (è£œè²¨ä¸­)"] },
                { title: "ä¾¿åˆ©å•†åº—", desc: "æ”¶éŠ€å°ç”¨èª", items: ["ãŠå¼å½“æ¸©ã‚ã¾ã™ã‹ (å¾®æ³¢å—)", "è¢‹ã«ãŠå…¥ã‚Œã—ã¾ã™ã‹ (è¦è¢‹å­å—)", "ãƒã‚¤ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ (é›†é»å¡)"] },
                { title: "ç´…ç¶ ç‡ˆ", desc: "æŒ‰éˆ•å¼è™ŸèªŒ", items: ["æŠ¼ã—ãƒœã‚¿ãƒ³å¼ (æŒ‰éˆ•å¼)", "ãŠå¾…ã¡ãã ã•ã„ (è«‹ç¨å€™)", "æ­©è¡Œè€… (è¡Œäºº)"] }
            ],
            "N4": [
                { title: "å†·æ°£é™æ§å™¨", desc: "æ¨¡å¼åˆ‡æ›", items: ["å†·æˆ¿ (å†·æ°£)", "æš–æˆ¿ (æš–æ°£)", "é™¤æ¹¿ (é™¤æ¿•)", "è‡ªå‹• (è‡ªå‹•)", "é¢¨é‡ (é¢¨é‡)"] },
                { title: "æ´—è¡£æ©Ÿ", desc: "æ“ä½œé¢æ¿", items: ["æ´—ã„ (æ´—è¡£)", "ã™ã™ã (æ´—æ¸…)", "è„±æ°´ (è„«æ°´)", "ä¹¾ç‡¥ (çƒ˜ä¹¾)", "ã‚³ãƒ¼ã‚¹ (è¡Œç¨‹)"] },
                { title: "é›»è»Šç«™", desc: "å„ç¨®åˆ—è»Š", items: ["æ™®é€š (æ¯ç«™åœ)", "å¿«é€Ÿ (åœå¤§ç«™)", "ç‰¹æ€¥ (æœ€å¿«/éœ€åŠ éŒ¢)", "å„ªå…ˆå¸­ (åšæ„›åº§)"] },
                { title: "é¤å»³é»é¤æ©Ÿ", desc: "å¸¸è¦‹æŒ‰éˆ•", items: ["åº—å†… (å…§ç”¨)", "æŒã¡å¸°ã‚Š (å¤–å¸¶)", "é ˜åæ›¸ (æ”¶æ“š)", "æ³¨æ–‡ (é»é¤)"] },
                { title: "ATM æ“ä½œ", desc: "ææ¬¾æ©Ÿä»‹é¢", items: ["ãŠå¼•ãå‡ºã— (ææ¬¾)", "ãŠé ã‘å…¥ã‚Œ (å­˜æ¬¾)", "æ®‹é«˜ç…§ä¼š (é¤˜é¡æŸ¥è©¢)", "ãŠæŒ¯è¾¼ã¿ (è½‰å¸³)"] }
            ],
            "N3": [
                { title: "åƒåœ¾åˆ†é¡", desc: "æ—¥æœ¬åš´æ ¼çš„åˆ†é¡", items: ["ç‡ƒãˆã‚‹ã‚´ãƒŸ (å¯ç‡ƒ)", "ç‡ƒãˆãªã„ã‚´ãƒŸ (ä¸å¯ç‡ƒ)", "ãƒšãƒƒãƒˆãƒœãƒˆãƒ« (å¯¶ç‰¹ç“¶)", "è³‡æºã”ã¿ (å›æ”¶)", "ç²—å¤§ã”ã¿ (å¤§å‹åƒåœ¾)"] },
                { title: "ç·Šæ€¥æ¨™ç¤º", desc: "ç½é›£æ™‚çš„æŒ‡å¼•", items: ["éå¸¸å£ (é€ƒç”Ÿå£)", "é¿é›£æ‰€ (é¿é›£æ‰€)", "æ´¥æ³¢æ³¨æ„ (æµ·å˜¯æ³¨æ„)", "ç«‹å…¥ç¦æ­¢ (ç¦æ­¢é€²å…¥)"] },
                { title: "éƒµå±€å¯„ä»¶", desc: "å–®æ“šå¡«å¯«", items: ["ãŠå±Šã‘å…ˆ (æ”¶ä»¶äºº)", "ã”ä¾é ¼ä¸» (å¯„ä»¶äºº)", "å“å (ç‰©å“åç¨±)", "ã‚ã‚Œã‚‚ã® (æ˜“ç¢å“)"] },
                { title: "ç§Ÿå±‹ç›¸é—œ", desc: "åˆç´„å¸¸è¦‹è©", items: ["å®¶è³ƒ (æˆ¿ç§Ÿ)", "æ•·é‡‘ (æŠ¼é‡‘)", "ç¤¼é‡‘ (ç¦®é‡‘)", "ç®¡ç†è²» (ç®¡ç†è²»)"] },
                { title: "è—¥å“æ¨™ç¤º", desc: "è—¥å¦åº—é¸è³¼", items: ["é ­ç—› (é ­ç—›)", "èƒƒç—› (èƒƒç—›)", "ç›®è–¬ (çœ¼è—¥æ°´)", "é£Ÿå‰/é£Ÿå¾Œ (é£¯å‰/å¾Œ)"] }
            ]
        };

        const dailySentences = [
            { jp: "åƒé‡Œã®é“ã‚‚ä¸€æ­©ã‹ã‚‰", kana: "Senri no michi mo ippo kara", cn: "åƒé‡Œä¹‹è¡Œï¼Œå§‹æ–¼è¶³ä¸‹" },
            { jp: "ä¸€æœŸä¸€ä¼š", kana: "Ichigo ichie", cn: "ä¸€ç”Ÿåªæœ‰ä¸€æ¬¡çš„ç›¸é‡" },
            { jp: "ç¶™ç¶šã¯åŠ›ãªã‚Š", kana: "Keizoku wa chikara nari", cn: "æŒä¹‹ä»¥æ†å°±æ˜¯åŠ›é‡" },
            { jp: "ä¸ƒè»¢ã³å…«èµ·ã", kana: "Nanakorobi yaoki", cn: "è·Œå€’ä¸ƒæ¬¡ï¼Œçˆ¬èµ·ä¾†å…«æ¬¡ï¼ˆç™¾æŠ˜ä¸æ’“ï¼‰" },
            { jp: "å¥½ãã“ãã‚‚ã®ã®ä¸Šæ‰‹ãªã‚Œ", kana: "Suki koso mono no jouzu nare", cn: "èˆˆè¶£æ˜¯æœ€å¥½çš„è€å¸«" },
            { jp: "æ€¥ãŒã°å›ã‚Œ", kana: "Isogaba maware", cn: "æ¬²é€Ÿå‰‡ä¸é” (æ€¥äº‹ç·©è¾¦)" },
            { jp: "å¡µã‚‚ç©ã‚‚ã‚Œã°å±±ã¨ãªã‚‹", kana: "Chiri mo tsumoreba yama to naru", cn: "ç©å°‘æˆå¤š" }
        ];

        // --- STATE ---
        let currentVocabLevel = 'N5';
        let currentVocabCategory = 'n5_greetings';
        let quizQuestions = [];
        let currentQuizIndex = 0;
        let quizScore = 0;
        let uploadedImageBase64 = null;

        window.onload = function() {
            setRandomDailySentence();
            renderKanaGrid(hiraganaData);
            const setVh = () => { document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); };
            window.addEventListener('resize', setVh); setVh();
        };

        function setRandomDailySentence() {
            const idx = Math.floor(Math.random() * dailySentences.length);
            const s = dailySentences[idx];
            document.getElementById('daily-sentence-jp').innerText = s.jp;
            document.getElementById('daily-sentence-reading').innerText = s.kana;
            document.getElementById('daily-sentence-cn').innerText = s.cn;
        }

        // --- NAVIGATION ---
        function switchTab(tabId) {
            ['home', 'roadmap', 'ai', 'quiz', 'kana', 'vocab', 'grammar', 'life'].forEach(id => {
                const el = document.getElementById(`view-${id}`); if(el) el.classList.add('hidden');
            });
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active', 'text-red-500'); el.classList.add('text-gray-400');
                if (el.dataset.target === tabId) { el.classList.add('active', 'text-red-500'); el.classList.remove('text-gray-400'); }
            });
            const titles = {'home':'é¦–é ','roadmap':'å­¸ç¿’è·¯å¾‘','ai':'AI å·¥å…·ç®±','quiz':'æ¸¬é©—','kana':'äº”åéŸ³','vocab':'å–®å­—æ¸…å–®','grammar':'æ–‡æ³•','life':'ç”Ÿæ´»'};
            document.getElementById('header-title').innerText = titles[tabId] || 'Pocket Nihongo';
            document.getElementById('app-content').scrollTop = 0;
        }

        function setAiMode(mode) {
            const modes = ['sensei', 'translator'];
            modes.forEach(m => {
                const el = document.getElementById(`ai-mode-${m}`);
                const btn = document.getElementById(`btn-mode-${m}`);
                if (m === mode) {
                    el.classList.remove('hidden');
                    if(m === 'translator') el.classList.add('flex');
                    btn.className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-white text-indigo-600 shadow transition-all";
                } else {
                    el.classList.add('hidden');
                    el.classList.remove('flex');
                    btn.className = "flex-1 py-1.5 text-xs font-bold rounded-md text-gray-500 hover:bg-gray-50 transition-all";
                }
            });
        }

        // --- GEMINI TTS (REALISTIC VOICE) ---
        function pcmToWav(pcmData, sampleRate = 24000) {
            const binaryString = window.atob(pcmData);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            const writeString = (view, offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + len, true); writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true);
            view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(view, 36, 'data');
            view.setUint32(40, len, true);
            return new Blob([view, bytes], { type: 'audio/wav' });
        }

        async function playGeminiTTS(text, lang = 'ja-JP') {
            if (!text) return;
            if (lang === 'zh-TW') {
                const u = new SpeechSynthesisUtterance(text); u.lang = 'zh-TW'; window.speechSynthesis.speak(u); return;
            }
            
            // Show Loading Toast
            const toast = document.getElementById('tts-toast');
            toast.classList.remove('hidden');
            toast.classList.add('flex');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }
                    })
                });
                if (!response.ok) throw new Error('TTS API Error');
                const data = await response.json();
                const audioContent = data.candidates[0].content.parts[0].inlineData.data;
                const blob = pcmToWav(audioContent);
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                
                audio.onplay = () => {
                    toast.classList.add('hidden');
                    toast.classList.remove('flex');
                };
                audio.onended = () => { URL.revokeObjectURL(url); };
                audio.play();
                
            } catch (e) {
                console.error("TTS Failed, falling back", e);
                toast.classList.add('hidden');
                toast.classList.remove('flex');
                const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; window.speechSynthesis.speak(u);
            }
        }

        function speakText(text) { playGeminiTTS(text, 'ja-JP'); }

        // --- VOCAB LIST (New) ---
        function filterVocabByLevel(level) {
            currentVocabLevel = level;
            switchTab('vocab');
            document.getElementById('vocab-level-badge').innerText = level;
            document.getElementById('vocab-level-badge').className = `text-[10px] px-2 py-0.5 rounded-full font-bold whitespace-nowrap badge-${level.toLowerCase()}`;
            renderVocabCategories();
            const keys = Object.keys(vocabData).filter(k => vocabData[k].level === currentVocabLevel);
            if(keys.length > 0) { currentVocabCategory = keys[0]; renderVocabList(); }
        }

        function renderVocabCategories() {
            const container = document.getElementById('vocab-categories'); container.innerHTML = '';
            Object.keys(vocabData).forEach(key => {
                if (vocabData[key].level === currentVocabLevel) {
                    const btn = document.createElement('button');
                    btn.className = `whitespace-nowrap px-4 py-1.5 rounded-full text-xs border transition mr-2 ${key === currentVocabCategory ? 'bg-gray-800 text-white' : 'bg-white text-gray-600'}`;
                    btn.innerText = vocabData[key].label;
                    btn.onclick = () => { currentVocabCategory = key; renderVocabCategories(); renderVocabList(); };
                    container.appendChild(btn);
                }
            });
        }

        function renderVocabList() {
            const container = document.getElementById('vocab-list');
            container.innerHTML = '';
            const list = vocabData[currentVocabCategory].items;
            list.forEach(item => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between active:bg-gray-50 transition cursor-pointer group';
                el.onclick = () => speakText(item.jp);
                el.innerHTML = `
                    <div class="flex-1">
                        <div class="font-bold text-lg text-gray-800 font-jp">${item.jp}</div>
                        <div class="text-xs text-indigo-500 font-medium">${item.kana}</div>
                        <div class="text-sm text-gray-600 mt-1">${item.mean}</div>
                    </div>
                    <button class="w-10 h-10 rounded-full bg-gray-50 text-indigo-400 flex items-center justify-center group-hover:bg-indigo-100 group-hover:text-indigo-600 transition">
                        <i class="fa-solid fa-volume-high"></i>
                    </button>
                `;
                container.appendChild(el);
            });
        }

        // --- AI ---
        async function callAiTeacher() {
            const promptInput = document.getElementById('ai-prompt');
            const userQuery = promptInput.value.trim();
            if (!userQuery) { alert("è«‹è¼¸å…¥æƒ…å¢ƒï¼"); return; }
            
            const container = document.getElementById('sensei-result');
            container.innerHTML = '<div class="text-center text-indigo-500 py-10"><i class="fa-solid fa-spinner fa-spin text-2xl"></i><br>AI æ€è€ƒä¸­...</div>';
            
            try {
                // Update 3: More content (5 phrases, 8 vocab)
                const systemPrompt = `You are a Japanese teacher. User scenario: "${userQuery}". 
                Provide 5 useful colloquial phrases and 8 relevant vocabulary words. 
                Output strict JSON: { 
                    "phrases": [{"jp": "...", "kana": "...", "romaji": "...", "mean": "Traditional Chinese translation"}], 
                    "vocab": [{"jp": "...", "kana": "...", "romaji": "...", "mean": "Traditional Chinese translation"}] 
                }`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }], generationConfig: { responseMimeType: "application/json" } })
                });
                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                
                let html = '<div class="space-y-4"><div><h4 class="font-bold text-indigo-600 mb-2">å¯¦ç”¨çŸ­å¥</h4>';
                result.phrases.forEach(p => { 
                    html += `
                    <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm mb-2" onclick="playGeminiTTS('${p.jp}')">
                        <div class="flex justify-between items-start">
                            <span class="font-bold font-jp text-lg">${p.jp}</span>
                            <i class="fa-solid fa-volume-high text-gray-300"></i>
                        </div>
                        <div class="text-xs text-indigo-500">${p.kana}</div>
                        <div class="text-[10px] text-gray-400 font-mono tracking-wide">${p.romaji}</div>
                        <div class="text-sm text-gray-700 mt-1 border-t border-gray-50 pt-1">${p.mean}</div>
                    </div>`; 
                });
                html += '</div><div><h4 class="font-bold text-pink-600 mb-2">é—œéµå–®å­—</h4><div class="grid grid-cols-1 gap-2">';
                result.vocab.forEach(v => { 
                    html += `
                    <div class="bg-white p-3 rounded border border-gray-100 flex items-center justify-between" onclick="playGeminiTTS('${v.jp}')">
                        <div>
                            <div class="font-bold font-jp text-base">${v.jp}</div>
                            <div class="text-xs text-pink-500">${v.kana}</div>
                            <div class="text-[10px] text-gray-400">${v.romaji}</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">${v.mean}</div>
                    </div>`; 
                });
                html += '</div></div></div>';
                container.innerHTML = html;
            } catch (error) { 
                console.error(error); 
                container.innerHTML = '<div class="text-center text-red-500">ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚</div>'; 
            }
        }

        async function callAiTranslation() {
            const textInput = document.getElementById('trans-text-input').value.trim();
            const hasImage = !!uploadedImageBase64;
            if (!textInput && !hasImage) { alert("è«‹è¼¸å…¥æ–‡å­—æˆ–ä¸Šå‚³åœ–ç‰‡ï¼"); return; }
            document.getElementById('trans-loading').classList.remove('hidden');
            document.getElementById('trans-result').classList.add('hidden');
            try {
                // Update 1: Smarter Translation Logic Prompt
                let promptText = `
                Translate the following text. 
                Rule 1: If the text is in Chinese (Traditional or Simplified) or consists solely of Kanji (e.g., "äº¬éƒ½"), treat it as Chinese and translate it into natural Japanese. Provide the Japanese text, Hiragana reading, and Romaji. 
                Rule 2: If the text is in Japanese (contains Hiragana/Katakana), translate it into Traditional Chinese.
                Return JSON: { "translation": "...", "reading": "Hiragana (only if JP output)", "romaji": "Romaji (only if JP output)" }
                `;
                
                let contentsParts = [{ text: promptText }];
                if (textInput) contentsParts.push({ text: `Text to translate: ${textInput}` });
                if (hasImage) contentsParts.push({ inlineData: { mimeType: "image/jpeg", data: uploadedImageBase64.split(',')[1] } });
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: contentsParts }], generationConfig: { responseMimeType: "application/json" } })
                });
                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                
                // Display logic
                document.getElementById('trans-output-text').innerText = result.translation;
                
                // Show reading if available (Japanese output)
                let metaText = "";
                if (result.reading) metaText += result.reading + "\n";
                if (result.romaji) metaText += result.romaji;
                
                document.getElementById('trans-output-romaji').innerText = metaText;
                
                document.getElementById('trans-loading').classList.add('hidden');
                document.getElementById('trans-result').classList.remove('hidden');
            } catch (error) { console.error(error); alert("ç¿»è­¯å¤±æ•—"); document.getElementById('trans-loading').classList.add('hidden'); }
        }

        function speakTransResult() {
            const text = document.getElementById('trans-output-text').innerText;
            // Simple heuristic: Japanese output has Kana
            const isJp = /[\u3040-\u309F\u30A0-\u30FF]/.test(text);
            playGeminiTTS(text, isJp ? 'ja-JP' : 'zh-TW');
        }

        // --- OTHER UTILS ---
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { uploadedImageBase64 = e.target.result; document.getElementById('image-preview').src = uploadedImageBase64; document.getElementById('image-preview').classList.remove('hidden'); document.getElementById('upload-placeholder').classList.add('hidden'); document.getElementById('btn-clear-img').classList.remove('hidden'); document.getElementById('image-preview-container').classList.add('border-indigo-500'); };
                reader.readAsDataURL(file);
            }
        }
        function clearImage() { uploadedImageBase64 = null; document.getElementById('image-upload').value = ''; document.getElementById('image-preview').src = ''; document.getElementById('image-preview').classList.add('hidden'); document.getElementById('upload-placeholder').classList.remove('hidden'); document.getElementById('btn-clear-img').classList.add('hidden'); document.getElementById('image-preview-container').classList.remove('border-indigo-500'); }
        function openKanaView() { switchTab('kana'); }
        function openGrammarView(l) { switchTab('grammar'); document.getElementById('grammar-level-badge').innerText = l; document.getElementById('grammar-level-badge').className = `text-[10px] px-2 py-0.5 rounded-full font-bold badge-${l.toLowerCase()}`; document.getElementById('grammar-list').innerHTML = grammarData[l].map(i=>`<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100" onclick="playGeminiTTS('${i.ex}')"><div class="flex justify-between items-start mb-1"><h3 class="font-bold text-lg text-green-700">${i.title}</h3><span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">${i.mean}</span></div><p class="text-sm text-gray-600 mb-3">${i.desc}</p><div class="bg-green-50 p-3 rounded-lg border border-green-100"><div class="flex justify-between"><p class="font-bold text-gray-800 font-jp">${i.ex}</p><i class="fa-solid fa-volume-high text-green-500 text-sm"></i></div><p class="text-xs text-gray-500 mt-1">${i.ex_mean}</p></div></div>`).join(''); }
        function openLifeView(l) { switchTab('life'); document.getElementById('life-level-badge').innerText = l; document.getElementById('life-level-badge').className = `text-[10px] px-2 py-0.5 rounded-full font-bold badge-${l.toLowerCase()}`; document.getElementById('life-list').innerHTML = lifeData[l].map(i=>`<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"><div class="flex items-center gap-2 mb-2"><div class="w-8 h-8 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center"><i class="fa-solid fa-lightbulb"></i></div><div><h3 class="font-bold text-gray-800">${i.title}</h3><div class="text-xs text-gray-400">${i.desc}</div></div></div><div class="mt-2">${i.items.map(t=>`<span class="inline-block bg-orange-50 text-orange-700 text-xs px-2 py-1 rounded mr-1 mb-1 border border-orange-100">${t}</span>`).join('')}</div></div>`).join(''); }
        function setKanaMode(m) { const h = document.getElementById('btn-hiragana'), k = document.getElementById('btn-katakana'); if(m==='hiragana'){h.className="flex-1 py-2 text-sm font-bold rounded-md bg-red-500 text-white shadow";k.className="flex-1 py-2 text-sm font-bold rounded-md text-gray-500 hover:bg-gray-50";renderKanaGrid(hiraganaData);}else{k.className="flex-1 py-2 text-sm font-bold rounded-md bg-red-500 text-white shadow";h.className="flex-1 py-2 text-sm font-bold rounded-md text-gray-500 hover:bg-gray-50";renderKanaGrid(katakanaData);}}
        function renderKanaGrid(d) { document.getElementById('kana-grid').innerHTML = d.map(i=>i.char?`<div class="w-full aspect-square bg-white rounded-lg shadow-sm border border-gray-100 flex flex-col items-center justify-center cursor-pointer active:scale-95 transition" onclick="playGeminiTTS('${i.char}')"><span class="text-xl font-bold text-gray-800 font-jp">${i.char}</span><span class="text-[10px] text-gray-400 font-sans">${i.romaji}</span></div>`:`<div class="w-full aspect-square"></div>`).join(''); }
        function startQuiz() { 
            const selectedLevel = document.getElementById('quiz-level-select').value;
            let allVocab = [];
            Object.keys(vocabData).forEach(key => {
                if (selectedLevel === 'ALL' || vocabData[key].level === selectedLevel) {
                    allVocab = allVocab.concat(vocabData[key].items);
                }
            });
            
            if(allVocab.length < 4) { alert("è©²ç´šåˆ¥å–®å­—ä¸è¶³"); return; }

            quizQuestions = [];
            for(let i=0; i<5; i++) {
                const correct = allVocab[Math.floor(Math.random() * allVocab.length)];
                const distractors = [];
                while(distractors.length < 3) {
                    const d = allVocab[Math.floor(Math.random() * allVocab.length)];
                    if(d.mean !== correct.mean && !distractors.includes(d.mean)) distractors.push(d.mean);
                }
                quizQuestions.push({ q: correct.jp, a: correct.mean, opts: shuffleArray([correct.mean, ...distractors]) });
            }
            currentQuizIndex = 0; quizScore = 0; document.getElementById('quiz-start').classList.add('hidden'); document.getElementById('quiz-active').classList.remove('hidden'); document.getElementById('quiz-active').classList.add('flex'); renderQuizQuestion(); 
        }
        function renderQuizQuestion() { 
            const q = quizQuestions[currentQuizIndex]; document.getElementById('quiz-question').innerText = q.q; 
            const opts = document.getElementById('quiz-options'); opts.innerHTML = ''; 
            q.opts.forEach(o=>{ const b = document.createElement('button'); b.className = 'w-full bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-left font-bold text-gray-700 active:bg-gray-50'; b.innerText = o; b.onclick=()=>checkAnswer(o, q.a, b); opts.appendChild(b); }); 
            playGeminiTTS(q.q);
        }
        function checkAnswer(sel, cor, btn) { 
            if(sel===cor) { btn.classList.add('bg-green-100', 'border-green-500', 'text-green-700'); quizScore += 20; document.getElementById('quiz-feedback').innerHTML = '<span class="text-green-500 font-bold">æ­£è§£ï¼</span>'; } 
            else { btn.classList.add('bg-red-100', 'border-red-500', 'text-red-700'); document.getElementById('quiz-feedback').innerHTML = `<span class="text-red-500 font-bold">éºæ†¾ï¼Œç­”æ¡ˆæ˜¯ ${cor}</span>`; }
            setTimeout(()=>{ currentQuizIndex++; if(currentQuizIndex<5) renderQuizQuestion(); else showQuizResults(); }, 1500);
        }
        function showQuizResults() { document.getElementById('quiz-active').classList.add('hidden'); document.getElementById('quiz-active').classList.remove('flex'); document.getElementById('quiz-result').classList.remove('hidden'); document.getElementById('result-score').innerText = quizScore; }
        function resetQuizView() { document.getElementById('quiz-result').classList.add('hidden'); document.getElementById('quiz-start').classList.remove('hidden'); }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
    </script>
</body>
</html>


